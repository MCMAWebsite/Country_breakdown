---
title: 'By Country Breakdown'
output: html_document
---
```{r include=F}
knitr::opts_chunk$set(echo=F)
knitr::opts_chunk$set(warning=F)
knitr::opts_chunk$set(message=F)

print("In Country_breakdown/by_country.Rmd")
country_breakdown_dir <- file.path(path.expand('~'), "Website", "Country_breakdown")

if(!require(tidyverse)) {install.packages("tidyverse", repos="https://cran.us.r-project.org")}
if(!require(kableExtra)) {install.packages("kableExtra", repos="https://cran.us.r-project.org")}
if(!require(DT)) {install.packages("DT", repos="https://cran.us.r-project.org")})

library(tidyverse)
library(readr)
library(kableExtra)
library(knitr)
library(lubridate)
library(DT)
library(RColorBrewer)
library(stringr)
library(scales)
Sys.setenv(TZ='EST')

mcma_objs = readRDS(file.path(country_breakdown_dir, "RDSfiles", "all_conjs"))
all_conjs = readRDS(file.path(country_breakdown_dir, "RDSfiles","all_conjs"))
all_conjs_expanded = readRDS(file.path(country_breakdown_dir, "RDSfiles", "all_conjs_expanded"))
derelicts = readRDS(file.path(country_breakdown_dir, "RDSfiles", "derelicts"))
derelictDat = readRDS(file.path(country_breakdown_dir, "RDSfiles", "derelictDatNew"))
alt_bins = readRDS(file.path(country_breakdown_dir, "RDSfiles", "alt_bins"))
file_list = readRDS(file.path(country_breakdown_dir, "RDSfiles", "file_list"))
all_conjs_2016 = readRDS(file.path(country_breakdown_dir, "RDSfiles", "all_conjs_2016"))

today = toupper(strftime(Sys.Date(), format="%d%b%Y")) # current day

# read in country codes
country_codes = read_csv("./country_codes.csv", 
                         col_names = c("country", "Country"), col_types = "cc", skip = 1) %>%
  mutate(Country = str_to_title(Country),
         Country = if_else(str_length(Country) > 20, country, Country))

# plot percent of encounters by country
p = all_conjs_expanded %>%
  left_join(dplyr::select(derelictDat, c(noradId, country)), by="noradId") %>%
  mutate(country = if_else(country == "CHBZ", "PRC", country),
         country = replace_na(country, "Other")) %>% 
  group_by(clusterLab, country) %>% 
  summarise(numEncounters = n()) %>% 
  left_join(country_codes, by="country") %>% 
  group_by(clusterLab) %>%
  mutate(encountersPerClust = sum(numEncounters), 
         p = numEncounters / encountersPerClust * 100) %>%
  group_by(clusterLab) %>%
  mutate(country_new = if_else(Country %in% c("CIS", "US", "China", "ESA", "France", "Germany", "India", "Japan"), Country, "Other")) %>% 
  group_by(clusterLab, country_new) %>%
  summarise(p = sum(p),
            encountersPerClust = round(min(encountersPerClust)/2)) %>%
  mutate(country_new = factor(country_new, 
                              levels = c("CIS", "US", "China", "ESA", "France", 
                                         "Germany", "India", "Japan", "Other"), 
                              ordered=T))

ggplot() + 
  geom_bar(data = p, aes(x=clusterLab, y=p/100, group=country_new, fill=country_new), stat="identity")+
  geom_text(data = unique(dplyr::select(p, c(clusterLab, encountersPerClust))), position = position_stack(vjust=1.05), 
            aes(x=clusterLab, y=1, label=encountersPerClust))+
  theme_minimal() +
  scale_y_continuous(labels = scales::percent) + 
  scale_fill_brewer(palette = "Set1")+
  labs(x="Cluster",y="", title = "Percent of Encounters by Country - misses within 5 km", fill="Country",
       subtitle="Number of encounters shown above each bar", caption=file.path("Encounters from 20OCT2019-", today))
```

```{r barchart500m, fig.width=7.5}
p = all_conjs_expanded %>%
  filter(Range <= 0.5) %>%
  left_join(dplyr::select(derelictDat, c(noradId, country)), by="noradId") %>%
  mutate(country = if_else(country == "CHBZ", "PRC", country),
         country = replace_na(country, "Other")) %>% 
  group_by(clusterLab, country) %>% 
  summarise(numEncounters = n()) %>% 
  left_join(country_codes, by="country") %>% 
  group_by(clusterLab) %>%
  mutate(encountersPerClust = sum(numEncounters), 
         p = numEncounters / encountersPerClust * 100) %>%
  group_by(clusterLab) %>%
  mutate(country_new = if_else(Country %in% c("CIS", "US", "China", "ESA", "France", "Germany", "India", "Japan"), Country, "Other")) %>% 
  group_by(clusterLab, country_new) %>%
  summarise(p = sum(p),
            encountersPerClust = round(min(encountersPerClust)/2)) %>%
  mutate(country_new = factor(country_new, 
                              levels = c("CIS", "US", "China", "ESA", "France", 
                                         "Germany", "India", "Japan", "Other"), 
                              ordered=T))

ggplot() + 
  geom_bar(data = p, aes(x=clusterLab, y=p/100, group=country_new, fill=country_new), stat="identity")+
  geom_text(data = unique(dplyr::select(p, c(clusterLab, encountersPerClust))), position = position_stack(vjust=1.05), 
            aes(x=clusterLab, y=1, label=encountersPerClust))+
  theme_minimal() +
  scale_y_continuous(labels = scales::percent) + 
  scale_fill_brewer(palette = "Set1")+
  labs(x="Cluster",y="", title = "Percent of Encounters by Country - misses within 500 m", fill="Country",
       subtitle="Number of encounters shown above each bar", caption=file.path("Encounters from 20OCT2019-", today))
